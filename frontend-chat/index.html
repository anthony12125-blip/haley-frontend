<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Async Chat Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .chat-container {
      width: 90%;
      max-width: 800px;
      height: 90vh;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    
    .chat-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-header h1 {
      font-size: 20px;
      color: #333;
    }
    
    .queue-status {
      font-size: 12px;
      color: #666;
      padding: 4px 12px;
      background: #f0f0f0;
      border-radius: 12px;
    }
    
    .queue-status.processing {
      background: #fff3cd;
      color: #856404;
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .message {
      display: flex;
      gap: 12px;
      max-width: 80%;
      animation: slideIn 0.2s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .message.user .message-avatar {
      background: #007bff;
      color: white;
    }
    
    .message.assistant .message-avatar {
      background: #6c757d;
      color: white;
    }
    
    .message-content {
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    .message.user .message-content {
      background: #007bff;
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .message.assistant .message-content {
      background: #f0f0f0;
      color: #333;
      border-bottom-left-radius: 4px;
    }
    
    .message.assistant.processing .message-content {
      background: #fff3cd;
    }
    
    .message-status {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }
    
    .typing-indicator {
      display: inline-block;
      padding: 2px 0;
    }
    
    .typing-indicator span {
      display: inline-block;
      width: 6px;
      height: 6px;
      background: #666;
      border-radius: 50%;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
    
    .chat-input-container {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 12px;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .chat-input:focus {
      border-color: #007bff;
    }
    
    .send-button {
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .send-button:hover {
      background: #0056b3;
    }
    
    .send-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>ðŸ¤– Async Chat Demo</h1>
      <div class="queue-status" id="queueStatus">Ready</div>
    </div>
    
    <div class="messages-container" id="messagesContainer">
      <!-- Messages will be inserted here -->
    </div>
    
    <div class="chat-input-container">
      <input 
        type="text" 
        class="chat-input" 
        id="messageInput" 
        placeholder="Type your message... (press Enter to send)"
        autocomplete="off"
      >
      <button class="send-button" id="sendButton">Send</button>
    </div>
  </div>

  <script src="async-chat-client.js"></script>
  <script>
    // Initialize chat client
    const chatClient = new AsyncChatClient({
      apiBaseUrl: 'http://localhost:8081',
      onMessage: handleMessage,
      onError: handleError,
      onStatusChange: handleStatusChange
    });
    
    // DOM elements
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const queueStatus = document.getElementById('queueStatus');
    
    // Message elements map (for updating)
    const messageElements = new Map();
    
    /**
     * Handle incoming/updated messages
     */
    function handleMessage(message) {
      let messageEl = messageElements.get(message.id || message.timestamp);
      
      if (!messageEl) {
        // Create new message element
        messageEl = createMessageElement(message);
        messagesContainer.appendChild(messageEl);
        messageElements.set(message.id || message.timestamp, messageEl);
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } else {
        // Update existing message
        updateMessageElement(messageEl, message);
      }
    }
    
    /**
     * Create message DOM element
     */
    function createMessageElement(message) {
      const div = document.createElement('div');
      div.className = `message ${message.role}`;
      if (message.status !== 'done') {
        div.classList.add(message.status);
      }
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = message.role === 'user' ? 'U' : 'AI';
      
      const contentWrapper = document.createElement('div');
      
      const content = document.createElement('div');
      content.className = 'message-content';
      content.textContent = message.content || '';
      
      // Add typing indicator for processing messages
      if (message.role === 'assistant' && message.status === 'processing') {
        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.innerHTML = '<span></span><span></span><span></span>';
        content.appendChild(indicator);
      }
      
      const status = document.createElement('div');
      status.className = 'message-status';
      status.textContent = getStatusText(message.status);
      
      contentWrapper.appendChild(content);
      contentWrapper.appendChild(status);
      
      div.appendChild(avatar);
      div.appendChild(contentWrapper);
      
      return div;
    }
    
    /**
     * Update existing message element
     */
    function updateMessageElement(element, message) {
      const content = element.querySelector('.message-content');
      const status = element.querySelector('.message-status');
      
      // Update content
      if (message.role === 'assistant' && message.status === 'processing') {
        // Show typing indicator
        if (!content.querySelector('.typing-indicator')) {
          content.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        }
      } else {
        // Remove typing indicator and show content
        const indicator = content.querySelector('.typing-indicator');
        if (indicator) {
          indicator.remove();
        }
        content.textContent = message.content || '';
      }
      
      // Update status
      status.textContent = getStatusText(message.status);
      
      // Update classes
      element.className = `message ${message.role}`;
      if (message.status !== 'done') {
        element.classList.add(message.status);
      }
    }
    
    /**
     * Get human-readable status text
     */
    function getStatusText(status) {
      const statusMap = {
        'queued': 'Queued...',
        'processing': 'Thinking...',
        'streaming': 'Responding...',
        'done': '',
        'failed': 'Failed'
      };
      return statusMap[status] || '';
    }
    
    /**
     * Handle errors
     */
    function handleError(error) {
      console.error('Chat error:', error);
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = `Error: ${error.message || error}`;
      messagesContainer.appendChild(errorDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => errorDiv.remove(), 5000);
    }
    
    /**
     * Handle status changes
     */
    function handleStatusChange(message) {
      updateQueueStatus();
    }
    
    /**
     * Update queue status indicator
     */
    async function updateQueueStatus() {
      try {
        const status = await chatClient.getQueueStatus();
        
        if (status.processing || status.queue_size > 0) {
          queueStatus.textContent = `Processing (${status.queue_size} queued)`;
          queueStatus.classList.add('processing');
        } else {
          queueStatus.textContent = 'Ready';
          queueStatus.classList.remove('processing');
        }
      } catch (error) {
        console.error('Failed to update queue status:', error);
      }
    }
    
    /**
     * Send message
     */
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      
      // Clear input immediately
      messageInput.value = '';
      
      // Disable send button temporarily
      sendButton.disabled = true;
      setTimeout(() => {
        sendButton.disabled = false;
        messageInput.focus();
      }, 100);
      
      try {
        await chatClient.submitMessage(text);
        updateQueueStatus();
      } catch (error) {
        // Error already handled by onError callback
        sendButton.disabled = false;
      }
    }
    
    // Event listeners
    sendButton.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // Update queue status periodically
    setInterval(updateQueueStatus, 2000);
    
    // Initial queue status
    updateQueueStatus();
    
    // Focus input on load
    messageInput.focus();
    
    // Demo: Add welcome message
    setTimeout(() => {
      handleMessage({
        role: 'assistant',
        content: 'Hello! I\'m your async chat assistant. You can send multiple messages at once - I\'ll process them in order! Try sending several messages quickly to see the queue in action.',
        status: 'done',
        timestamp: new Date().toISOString()
      });
    }, 500);
  </script>
</body>
</html>
